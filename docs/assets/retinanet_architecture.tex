\documentclass[border=8pt, multi, tikz]{standalone}
\usepackage{import}
\subimport{../plot_neural_net/layers/}{init}

\usetikzlibrary{calc,arrows.meta,positioning}

% ---- Colors ----
\def\ConvColor{rgb:yellow,5;red,2.5;white,5}
\def\ConvReluColor{rgb:yellow,5;red,5;white,5}
\def\FPNColor{rgb:blue,5;green,3;white,5}
\def\HeadColor{rgb:magenta,5;black,7}

% ---- Arrow styles ----
\tikzset{
  connection/.style={ultra thick, -{Stealth}},
  skipconn/.style={ultra thick, dashed, -{Stealth}}
}

\begin{document}
\begin{tikzpicture}

% ============ Backbone: C1..C5 ============
\pic at (0,0,0)
  {RightBandedBox={name=C1, caption=C1, xlabel={{},{ }}, fill=\ConvColor, bandfill=\ConvReluColor, height=28, width=2, depth=28}};
\pic[shift={(2.4,0,0)}] at (C1-east)
  {RightBandedBox={name=C2, caption=C2, xlabel={{},{ }}, fill=\ConvColor, bandfill=\ConvReluColor, height=22, width=2, depth=22}};
\pic[shift={(2.4,0,0)}] at (C2-east)
  {RightBandedBox={name=C3, caption=C3, xlabel={{},{ }}, fill=\ConvColor, bandfill=\ConvReluColor, height=16, width=2, depth=16}};
\pic[shift={(2.4,0,0)}] at (C3-east)
  {RightBandedBox={name=C4, caption=C4, xlabel={{},{ }}, fill=\ConvColor, bandfill=\ConvReluColor, height=12, width=2, depth=12}};
\pic[shift={(2.4,0,0)}] at (C4-east)
  {RightBandedBox={name=C5, caption=C5, xlabel={{},{ }}, fill=\ConvColor, bandfill=\ConvReluColor, height=8, width=2, depth=8}};

\draw[connection] (C1-east) -- (C2-west);
\draw[connection] (C2-east) -- (C3-west);
\draw[connection] (C3-east) -- (C4-west);
\draw[connection] (C4-east) -- (C5-west);

% ============ Laterals (1x1) from C3,C4,C5 ============
\pic[shift={(0.8,7,0)}] at (C3-north)
  {RightBandedBox={name=P3l, caption=, xlabel={{},{ }}, fill=\FPNColor, bandfill=\FPNColor, height=12, width=1.5, depth=12}};
\draw[connection] (C3-north) -- (P3l-south);

\pic[shift={(0.8,6.2,0)}] at (C4-north)
  {RightBandedBox={name=P4l, caption=, xlabel={{},{ }}, fill=\FPNColor, bandfill=\FPNColor, height=9, width=1.5, depth=9}};
\draw[connection] (C4-north) -- (P4l-south);

\pic[shift={(0.8,5.0,0)}] at (C5-north)
  {RightBandedBox={name=P5l, caption=, xlabel={{},{ }}, fill=\FPNColor, bandfill=\FPNColor, height=6, width=1.5, depth=6}};
\draw[connection] (C5-north) -- (P5l-south);

% ============ Top-down pathway & merges: P5,P4,P3 ============
\pic[shift={(2.2,0,0)}] at (P5l-east)
  {RightBandedBox={name=P5, caption=P5, xlabel={{},{ }}, fill=\FPNColor, bandfill=\FPNColor, height=6, width=1.6, depth=6}};
\draw[connection] (P5l-east) -- (P5-west);

% P4 = up(P5) + P4l
\node[draw, circle, thick, minimum size=8pt, fill=white, label=right:{\scriptsize $\Sigma$}] (sumP4) at ($(P4l-east)+(1.4,0,0)$) {};
% 바깥쪽으로 크게 굽혀서 충돌 회피
\draw[skipconn] (P5-west) to[out=200,in=90] ($(sumP4.north)+(0.0,0)$);
\draw[connection] (P4l-east) -- (sumP4.west);
\pic[shift={(1.3,0,0)}] at (sumP4.east)
  {RightBandedBox={name=P4, caption=P4, xlabel={{},{ }}, fill=\FPNColor, bandfill=\FPNColor, height=9, width=1.6, depth=9}};

% P3 = up(P4) + P3l
\node[draw, circle, thick, minimum size=8pt, fill=white, label=right:{\scriptsize $\Sigma$}] (sumP3) at ($(P3l-east)+(1.4,0,0)$) {};
\draw[skipconn] (P4-west) to[out=160,in=90] ($(sumP3.north)+(0.0,0)$);
\draw[connection] (P3l-east) -- (sumP3.west);
\pic[shift={(1.3,0,0)}] at (sumP3.east)
  {RightBandedBox={name=P3, caption=P3, xlabel={{},{ }}, fill=\FPNColor, bandfill=\FPNColor, height=12, width=1.6, depth=12}};

% ============ Extra pyramid levels: P6,P7 (더 오른쪽/아래로) ============
\pic[shift={(3.2,-1.2,0)}] at (P5-south)
  {RightBandedBox={name=P6, caption=P6, xlabel={{},{ }}, fill=\FPNColor, bandfill=\FPNColor, height=4.5, width=1.6, depth=4.5}};
\draw[connection] (P5-south) -- (P6-north);

\pic[shift={(3.0,-1.0,0)}] at (P6-south)
  {RightBandedBox={name=P7, caption=P7, xlabel={{},{ }}, fill=\FPNColor, bandfill=\FPNColor, height=3.2, width=1.6, depth=3.2}};
\draw[connection] (P6-south) -- (P7-north);

% ============ Heads (Cls/Box) for each P3..P7 ============
% 레벨마다 x-간격을 늘려 겹침 방지 (3.2 + 0.7*(i-3))
\foreach \P/\i [evaluate=\i as \dx using {3.2 + 0.7*(\i-3)}] in {P3/3, P4/4, P5/5, P6/6, P7/7}{
  \pic[shift={(\dx, 1.4, 0)}] at (\P-east)
    {RightBandedBox={name=cls\i, caption=Cls, xlabel={{},{ }}, fill=\HeadColor, bandfill=\HeadColor, height=4.0, width=1.2, depth=4.0}};
  \pic[shift={(\dx,-1.4, 0)}] at (\P-east)
    {RightBandedBox={name=box\i, caption=Box, xlabel={{},{ }}, fill=\HeadColor, bandfill=\HeadColor, height=4.0, width=1.2, depth=4.0}};
  \draw[connection] (\P-east) -- (cls\i-west);
  \draw[connection] (\P-east) -- (box\i-west);
}

% ============ Title ============
\node[anchor=south west] at ($(C1-north west)+(-0.6,9.5)$) {\Large RetinaNet: C1--C5 Backbone, FPN P3--P7, Two Heads (Cls/Box)};

\end{tikzpicture}
\end{document}
